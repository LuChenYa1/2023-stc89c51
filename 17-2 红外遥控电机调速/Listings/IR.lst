C51 COMPILER V9.59.0.0   IR                                                                04/26/2023 15:47:00 PAGE 1   


C51 COMPILER V9.59.0.0, COMPILATION OF MODULE IR
OBJECT MODULE PLACED IN .\Objects\IR.obj
COMPILER INVOKED BY: D:\Keil_v5\C51\BIN\C51.EXE IR.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listings\IR.lst
                    -) OBJECT(.\Objects\IR.obj)

line level    source

   1          #include <REGX51.H>
   2          #include "Timer0_Init.h"
   3          #include "Int0.h"
   4          
   5          //红外光线经处理传进单片机内部，变成方波信号，其下降沿能被读取并触发外部中断
   6          unsigned char IR_State;//状态:空闲、预启动、数据解码
   7          unsigned int  IR_Time; //时间计数
   8          
   9          unsigned char IR_RepeatFlag;//重复标志位
  10          unsigned char IR_Data[4];//数据
  11          unsigned char IR_pData;//数据位数
  12          
  13          unsigned char IR_Address;//地址码
  14          unsigned char IR_Command;//命令码
  15          unsigned char IR_DataFlag;////数据完毕标志位
  16          
  17          
  18          
  19          /**
  20            * @brief  红外线解码初始化
  21            * @param  无
  22            * @retval 无
  23            */
  24          void IR_Init()
  25          {
  26   1              Timer0_Init();
  27   1              Int0_Init();
  28   1      }
  29          
  30          
  31          
  32          /**
  33            * @brief  得到重复标志位
  34            * @param  无
  35            * @retval IR_RepeatFlag：1为重复信号，0为非重复信号
  36            */
  37          unsigned char IR_GetRepeatFlag(void)
  38          {
  39   1              if(IR_RepeatFlag)
  40   1              {
  41   2                      IR_RepeatFlag=0;
  42   2                      return 1;
  43   2              }
  44   1              return 0;
  45   1      }
  46          
  47          
  48          
  49          /**
  50            * @brief  得到数据解码标志位
  51            * @param  无
  52            * @retval IR_DataFlag：1为数据解码完毕，0为正在解码或非解码
  53            */
  54          unsigned char IR_GetDataFlag(void)
C51 COMPILER V9.59.0.0   IR                                                                04/26/2023 15:47:00 PAGE 2   

  55          {
  56   1              if(IR_DataFlag)
  57   1              {
  58   2                      IR_DataFlag=0;
  59   2                      return 1;
  60   2              }
  61   1              return 0;
  62   1      }
  63          
  64          
  65          
  66          /**
  67            * @brief  得到红外方波信号的地址码
  68            * @param  无
  69            * @retval IR_Address：地址码
  70            */
  71          unsigned char IR_GetAddress(void)
  72          {
  73   1              return IR_Address;
  74   1      }
  75          
  76          
  77          
  78          /**
  79            * @brief  得到红外方波信号的命令码
  80            * @param  无
  81            * @retval IR_Command：命令码
  82            */
  83          unsigned char IR_GetCommand(void)
  84          {
  85   1              return IR_Command;
  86   1      }
  87          
  88          
  89          
  90          //外部中断执行函数：下降沿触发
  91          void Int0_Routine(void)  interrupt 0
  92          {
  93   1               if(IR_State==0)//空闲状态，刚开始接收到下降沿
  94   1               { 
  95   2                       Timer0_SetCounter(0);
  96   2                       Timer0_Run(1);//开始计算两个下降沿的间隔时间
  97   2                       IR_State=1;
  98   2               }
  99   1               
 100   1               else if(IR_State==1)//预启动状态:判断接下来是重复空闲还是开始解码
 101   1               { 
 102   2                       P2=~0x01;
 103   2                       IR_Time=Timer0_GetCounter();
 104   2                       Timer0_SetCounter(0);
 105   2                       
 106   2                       if(IR_Time<13500+500 && IR_Time>13500-500)     //开始信号：信号解码成数据
 107   2                       {  
 108   3                              IR_State=2;
 109   3                       }
 110   2                       
 111   2                       else if(IR_Time<11250+500 && IR_Time>11250-500)//重复信号：重复发空值，那就是空闲
 112   2                       {
 113   3                               IR_RepeatFlag=1;//重复标志位
 114   3                               IR_State=0;
 115   3                               Timer0_Run(0);//停止计数
 116   3                       }
C51 COMPILER V9.59.0.0   IR                                                                04/26/2023 15:47:00 PAGE 3   

 117   2                       
 118   2                       else//以防解码出错
 119   2                       {
 120   3                              IR_State=1; 
 121   3                       }
 122   2               }
 123   1               else if(IR_State==2)//开始解码
 124   1               {
 125   2                       IR_Time=Timer0_GetCounter();//数据信号
 126   2                       Timer0_SetCounter(0);
 127   2                       
 128   2                       if(IR_Time<1120+500 && IR_Time>1120-500)//逻辑0
 129   2                       {
 130   3                               IR_Data[IR_pData/8] &= ~(0x01<<(IR_pData%8));
 131   3                               IR_pData++;
 132   3                       }
 133   2                       else if(IR_Time<2250+500 && IR_Time>2250-500)//逻辑1
 134   2                       {
 135   3                               IR_Data[IR_pData/8] |= (0x01<<(IR_pData%8));
 136   3                               IR_pData++;
 137   3                       }
 138   2                       else
 139   2                       {
 140   3                               IR_pData=0;
 141   3                               IR_State=1;
 142   3                       }
 143   2                       if(IR_pData==32)//4个字节数据传输完毕
 144   2                       {
 145   3                               IR_pData=0;
 146   3                               if(IR_Data[0]==~IR_Data[1]&&IR_Data[2]==~IR_Data[3])//地址+反码+命令+反码
 147   3                               {
 148   4                                       IR_Address=IR_Data[0];
 149   4                                       IR_Command=IR_Data[2];
 150   4                                       IR_DataFlag=1;//数据完毕标志位
 151   4                               }
 152   3                               IR_State=0;   //一串数据信号解码完毕
 153   3                               Timer0_Run(0);//停止计数
 154   3                       }
 155   2               }
 156   1      }
 157          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    369    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     12    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
